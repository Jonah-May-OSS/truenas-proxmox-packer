# action.yml
name: freenas-proxmox Package
on:
  repository_dispatch:
    types: [build_push]

jobs:
  build_master:
    if: contains(github.event.client_payload.ref, 'master')
    runs-on: ubuntu-latest
    name: Build freenas-proxmox Debian package - master Branch.
    steps:
      - name: Install dpkg.
        run: sudo apt-get install dpkg

      - name: Checkout freenas-proxmox-packer.
        uses: actions/checkout@v2

      - name: Package the master branch in a deb file.
        run: |
          sudo chmod 0755 testing/DEBIAN/postinst
          sudo chmod 0755 testing/DEBIAN/postrm
          sudo dpkg-deb -Zgzip --build testing freenas-proxmox-2.0.0-0-beta6_all.deb

      - name: Upload package to repo.
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.KSAT_REPO_HOST }}
          username: ${{ secrets.KSAT_REPO_USERNAME }}
          password: ${{ secrets.KSAT_REPO_PASSWORD }}
          port: ${{ secrets.KSAT_REPO_PORT }}
          source: ./freenas-proxmox-2.0.0-0-beta6_all.deb
          target: ${{ secrets.KSAT_REPO_TESTING_TARGET }}/freenas-proxmox-2.0.0-0-beta6_all.deb

  build_v1:
    name: Build freenas-proxmox Debian package - 1.0 Branch
    if: contains(github.event.client_payload.ref, '1.0')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout freenas-proxmox-packer.
        uses: actions/checkout@v2

      - name: Install dpkg.
        run: sudo apt-get install dpkg

      - name: Packaging for the 1.0 branch.
        run: |
          sudo chmod 0755 stable/v1.0/DEBIAN/postinst
          sudo chmod 0755 stable/v1.0/DEBIAN/postrm
          sudo dpkg-deb -Zgzip --build stable/v1.0 freenas-proxmox-1.0.0-1_all.deb

  build_v2:
    name: Build freenas-proxmox Debian package - 2.0 Branch
    if: contains(github.event.client_payload.ref, '2.0')
    runs-on: ubuntu-latest
    steps:
      - name: Make sure dpkg is installed.
        run: sudo apt-get install dpkg

      - name: Checkout freenas-proxmox-packer.
        uses: actions/checkout@v2

      - name: Packaging for the 2.0 branch.
        run: |
          sudo chmod 0755 stable/v2.0/DEBIAN/postinst
          sudo chmod 0755 stable/v2.0/DEBIAN/postrm
          sudo dpkg-deb -Zgzip --build stable/v2.0 freenas-proxmox-2.0.0-1_all.deb

      - name: Upload package to repo.
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.KSAT_REPO_HOST }}
          username: ${{ secrets.KSAT_REPO_USERNAME }}
          password: ${{ secrets.KSAT_REPO_PASSWORD }}
          port: ${{ secrets.KSAT_REPO_PORT }}
          source: ./freenas-proxmox-2.0.0-1_all.deb
          target: ${{ secrets.KSAT_REPO_STABLE_TARGET }}/freenas-proxmox-2.0.0-1_all.deb
