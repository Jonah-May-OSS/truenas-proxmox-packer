#!/bin/bash
# Abort immediately on any errors or unset variables
set -euo pipefail

# Debugging toggle
_DEBUG="on"

# Define standard Proxmox paths
LIB_PATH="/usr/share"
PVEMANAGER_FILEPATH="${LIB_PATH}/pve-manager/js/pvemanagerlib.js"
ZFSPLUGIN_FILEPATH="${LIB_PATH}/perl5/PVE/Storage/ZFSPlugin.pm"
APIDOC_FILEPATH="${LIB_PATH}/pve-docs/api-viewer/apidoc.js"
TRUENAS_PLUGIN_FILEPATH="${LIB_PATH}/perl5/PVE/Storage/LunCmd/TrueNAS.pm"
REST_CLIENT_FILEPATH="${LIB_PATH}/perl5/REST/Client.pm"

echo "Running TrueNAS-Proxmox post-install script..."

case "${1:-configure}" in
  configure)
    echo "Verifying required files after install..."

    missing=0

    # Verify critical files exist
    for file in "${PVEMANAGER_FILEPATH}" "${ZFSPLUGIN_FILEPATH}" "${APIDOC_FILEPATH}" "${TRUENAS_PLUGIN_FILEPATH}" "${REST_CLIENT_FILEPATH}"; do
      if [ ! -f "$file" ]; then
        echo "ERROR: Required file missing: $file"
        missing=1
      fi
    done

    if [ "$missing" -ne 0 ]; then
      echo "One or more required files are missing. Aborting installation."
      exit 1
    fi

    echo "All required files are present."

    # Optionally reload Proxmox services
    echo "Reloading Proxmox services (best effort)..."
    systemctl reload-or-restart pvedaemon.service || true
    systemctl reload-or-restart pveproxy.service || true
    systemctl reload-or-restart pvestatd.service || true
    systemctl reload-or-restart pvescheduler.service || true

    echo "TrueNAS-Proxmox integration successfully installed."
    ;;

  abort-upgrade|abort-remove|abort-deconfigure)
    echo "Post-install abort detected. No changes applied."
    ;;

  *)
    echo "ERROR: Unknown action '$1'" >&2
    exit 1
    ;;
esac

exit 0
