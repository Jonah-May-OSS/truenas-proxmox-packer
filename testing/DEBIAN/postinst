#!/bin/bash
# Abort immediately on any errors or unset variables
set -euo pipefail

# Debug toggle
_DEBUG="on"

# ── Detect Proxmox version ──────────────────────────────────────────────────────
if command -v pveversion >/dev/null 2>&1; then
  PVE_VERSION=$(pveversion -v | awk '/^pve-manager:/ {print $2}' | head -1)
else
  PVE_VERSION=$(grep '^VERSION_ID=' /etc/os-release | cut -d\" -f2 || echo "")
fi
MAJOR_VER=${PVE_VERSION%%.*}

[ "$_DEBUG" = "on" ] && echo "Proxmox Version: $PVE_VERSION"
[ "$_DEBUG" = "on" ] && echo "Proxmox Major Version: $MAJOR_VER"

# ── Set LIB_PATH based on major version ─────────────────────────────────────────
case "$MAJOR_VER" in
  7) LIB_PATH="/usr/share/pve-7" ;;
  *) LIB_PATH="/usr/share"      ;;
esac

# ── Define plugin file locations ────────────────────────────────────────────────
PVEMANAGER_FILEPATH="${LIB_PATH}/pve-manager/js/pvemanagerlib.js"
ZFSPLUGIN_FILEPATH="${LIB_PATH}/perl5/PVE/Storage/ZFSPlugin.pm"
APIDOC_FILEPATH="${LIB_PATH}/pve-docs/api-viewer/apidoc.js"
TRUENAS_PLUGIN_FILEPATH="${LIB_PATH}/perl5/PVE/Storage/LunCmd/TrueNAS.pm"
REST_CLIENT_FILEPATH="${LIB_PATH}/perl5/REST/Client.pm"

echo "Running TrueNAS-Proxmox post-install script..."

case "${1:-configure}" in
  configure)
    echo "Verifying required files after install..."

    missing=0
    for file in \
      "$PVEMANAGER_FILEPATH" \
      "$ZFSPLUGIN_FILEPATH" \
      "$APIDOC_FILEPATH" \
      "$TRUENAS_PLUGIN_FILEPATH" \
      "$REST_CLIENT_FILEPATH"
    do
      if [ ! -f "$file" ]; then
        echo "  ERROR: Required file missing: $file"
        missing=1
      fi
    done

    if [ "$missing" -ne 0 ]; then
      echo "One or more required files are missing. Aborting installation."
      exit 1
    fi

    echo "All required files are present."

    echo "Reloading Proxmox services (best effort)..."
    systemctl reload-or-restart pvedaemon.service  || true
    systemctl reload-or-restart pveproxy.service   || true
    systemctl reload-or-restart pvestatd.service   || true
    systemctl reload-or-restart pvescheduler.service || true

    echo "TrueNAS-Proxmox integration successfully installed."
    ;;

  abort-upgrade|abort-remove|abort-deconfigure)
    echo "Post-install abort detected. No changes applied."
    ;;

  *)
    echo "ERROR: Unknown action '$1'" >&2
    exit 1
    ;;
esac

exit 0
